<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cipher Challenge</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; max-width: 900px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        #status { font-weight: bold; margin: 20px 0; color: #d35400; }

        /* The Draggable Columns */
        .column-container { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
            justify-content: center; 
            min-height: 200px;
        }

        .column { 
            background: #fff; 
            border: 2px solid #333; 
            border-radius: 4px; 
            width: 60px; 
            padding: 10px; 
            cursor: grab; 
            user-select: none;
        }

        .column-header { 
            font-size: 1.5rem; 
            font-weight: bold; 
            border-bottom: 2px solid #333; 
            margin-bottom: 10px; 
            background: #eee;
        }

        .column-data { 
            font-family: monospace; 
            font-size: 1.2rem; 
            white-space: pre; 
        }

        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Column Decryption Game</h1>
    <div id="status">Loading challenge.txt...</div>
    
    <button id="startBtn" onclick="generatePuzzle()" disabled>Start Game</button>

    <div class="hidden">
        <input type="text" id="keyField">
        <textarea id="textField"></textarea>
    </div>

    <div id="columnWrapper" class="column-container"></div>
</div>

<script>
    let correctOrder = [];
    let draggedItem = null;

    // Load file from GitHub
    window.addEventListener('DOMContentLoaded', () => {
        fetch('challenge.txt')
            .then(res => res.text())
            .then(data => {
                const lines = data.split(/\r?\n/);
                document.getElementById('keyField').value = lines[0].trim().toUpperCase();
                document.getElementById('textField').value = lines.slice(1).join(" ").trim();
                document.getElementById('status').innerText = "File loaded! Click Start.";
                document.getElementById('startBtn').disabled = false;
            })
            .catch(err => {
                document.getElementById('status').innerText = "Error: Could not find challenge.txt";
            });
    });

    function generatePuzzle() {
        const key = document.getElementById('keyField').value.replace(/[^A-Z]/g, '');
        let text = document.getElementById('textField').value.replace(/\s+/g, '').toUpperCase();
        const wrapper = document.getElementById('columnWrapper');

        wrapper.innerHTML = '';
        const numCols = key.length;
        let columns = Array.from({ length: numCols }, (_, i) => ({ id: i, char: key[i], data: "" }));

        for (let i = 0; i < text.length; i++) {
            columns[i % numCols].data += text[i] + "\n";
        }

        correctOrder = columns.map(c => c.id);
        const shuffled = [...columns].sort(() => Math.random() - 0.5);

        render(shuffled);
        document.getElementById('status').innerText = "Drag the columns to spell the secret key!";
    }

    function render(cols) {
        const wrapper = document.getElementById('columnWrapper');
        wrapper.innerHTML = '';
        cols.forEach(col => {
            const div = document.createElement('div');
            div.className = 'column';
            div.draggable = true;
            div.dataset.id = col.id;
            div.innerHTML = `<div class="column-header">${col.char}</div><div class="column-data">${col.data}</div>`;
            
            // Core Drag Events
            div.addEventListener('dragstart', (e) => {
                draggedItem = div;
                e.dataTransfer.setData('text/plain', ''); // Required for Firefox
            });

            div.addEventListener('dragover', (e) => {
                e.preventDefault(); // Required to allow drop
            });

            div.addEventListener('drop', function(e) {
                e.preventDefault();
                if (this === draggedItem) return;

                const all = Array.from(document.querySelectorAll('.column'));
                const draggedIdx = all.indexOf(draggedItem);
                const targetIdx = all.indexOf(this);

                if (draggedIdx < targetIdx) {
                    this.after(draggedItem);
                } else {
                    this.before(draggedItem);
                }
                checkWin();
            });

            wrapper.appendChild(div);
        });
    }

    function checkWin() {
        const current = Array.from(document.querySelectorAll('.column')).map(el => parseInt(el.dataset.id));
        if (JSON.stringify(current) === JSON.stringify(correctOrder)) {
            document.getElementById('status').innerText = "ðŸŽ‰ YOU GOT IT!";
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    }
</script>
</body>
</html>